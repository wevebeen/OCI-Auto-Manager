name: OCI Ubuntu ARM Instance Auto-Manager

# è§¦å‘æ¡ä»¶
on:
  # å®šæ—¶è§¦å‘ï¼šæ¯2å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆæ•´ç‚¹æ‰§è¡Œï¼‰
  schedule:
    - cron: '0 */2 * * *'
  # æ‰‹åŠ¨è§¦å‘ï¼šå…è®¸é€šè¿‡GitHubç•Œé¢æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
    inputs:
      manual_trigger_reason:
        description: 'æ‰‹åŠ¨è§¦å‘åŸå› '
        required: false
        default: 'æµ‹è¯•æˆ–ç´§æ€¥æ“ä½œ'
      skip_instance_check:
        description: 'è·³è¿‡å®ä¾‹æ£€æŸ¥ï¼ˆç›´æ¥å°è¯•åˆ›å»ºï¼‰'
        required: false
        type: boolean
        default: false
      max_retries:
        description: 'æœ€å¤§é‡è¯•æ¬¡æ•°'
        required: false
        type: choice
        options:
          - '3'
          - '5'
          - '10'
        default: '3'

jobs:
  manage-oci-instances:
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 30

    steps:
      # ==========================================================================
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç ä»“åº“
      # ==========================================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ==========================================================================
      # æ­¥éª¤2ï¼šé…ç½®OCIè®¤è¯ä¿¡æ¯
      # æ‰€éœ€Secretsï¼š
      # - OCI_USER: Oracle Cloudç”¨æˆ·OCID
      # - OCI_TENANCY: Oracle Cloudç§Ÿæˆ·OCID
      # - OCI_FINGERPRINT: APIå¯†é’¥æŒ‡çº¹
      # - OCI_REGION: åŒºåŸŸæ ‡è¯†ç¬¦ï¼ˆå¦‚ï¼šus-ashburn-1ï¼‰
      # - OCI_PRIVATE_KEY: APIç§é’¥å†…å®¹ï¼ˆPEMæ ¼å¼ï¼‰
      # ==========================================================================
      - name: Configure OCI authentication
        run: |
          echo "=== é…ç½®OCIè®¤è¯ä¿¡æ¯ ==="
          
          # åˆ›å»ºOCIé…ç½®ç›®å½•
          mkdir -p ~/.oci
          
          # ç”ŸæˆOCIé…ç½®æ–‡ä»¶
          cat > ~/.oci/config << 'CONFIG_EOF'
          [DEFAULT]
          user=${{ secrets.OCI_USER }}
          tenancy=${{ secrets.OCI_TENANCY }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          region=${{ secrets.OCI_REGION }}
          key_file=~/.oci/oci_api_key.pem
          CONFIG_EOF
          
          # éªŒè¯ç§é’¥æ˜¯å¦å­˜åœ¨
          if [ -z "${{ secrets.OCI_PRIVATE_KEY }}" ]; then
            echo "âŒ OCI_PRIVATE_KEY secret is empty or not available"
            echo "æç¤ºï¼š"
            echo "   - æ£€æŸ¥ä»“åº“ Secrets é…ç½®"
            echo "   - å¦‚æœè¿™æ˜¯ fork çš„ PRï¼ŒGitHub ä¸ä¼šæ³¨å…¥ Secrets"
            exit 1
          fi

          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/oci_api_key.pem

          # è®¾ç½®æ–‡ä»¶æƒé™ï¼ˆOCI CLI å®‰å…¨è¦æ±‚ï¼‰
          chmod 600 ~/.oci/config
          chmod 600 ~/.oci/oci_api_key.pem

          # éªŒè¯æ–‡ä»¶
          echo "é…ç½®éªŒè¯ï¼š"
          echo "- é…ç½®æ–‡ä»¶å¤§å°: $(wc -c < ~/.oci/config) bytes"
          echo "- ç§é’¥æ–‡ä»¶å¤§å°: $(wc -c < ~/.oci/oci_api_key.pem) bytes"
          echo "- ç§é’¥æœ«è¡Œ: '$(tail -n 1 ~/.oci/oci_api_key.pem)'"
          
          echo "âœ… OCIè®¤è¯é…ç½®å®Œæˆ"

      # ==========================================================================
      # æ­¥éª¤3ï¼šå®‰è£…OCI CLIå·¥å…·
      # ==========================================================================
      - name: Install OCI CLI
        run: |
          echo "=== å®‰è£…OCI CLIå·¥å…· ==="
          
          # ä¸‹è½½å¹¶å®‰è£…OCI CLI
          curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh | bash -s -- --accept-all-defaults
          
          # é…ç½®ç¯å¢ƒå˜é‡
          echo 'export PATH=$HOME/bin:$PATH' >> ~/.bashrc
          source ~/.bashrc
          
          # å°† OCI CLI è·¯å¾„æ·»åŠ åˆ° GITHUB_PATH
          echo "$HOME/bin" >> $GITHUB_PATH
          export PATH="$HOME/bin:$PATH"
          
          # éªŒè¯å®‰è£…
          oci --version
          echo "âœ… OCI CLIå®‰è£…å®Œæˆ"

      # ==========================================================================
      # æ­¥éª¤3.1ï¼šæµ‹è¯•è®¤è¯ï¼ˆå¯é€‰ï¼‰
      # ==========================================================================
      - name: Test OCI connection
        continue-on-error: true
        run: |
          echo "=== æµ‹è¯•OCIè¿æ¥ ==="
          
          # æµ‹è¯•ç”¨æˆ·æƒé™
          user_info=$(oci iam user get --user-id "${{ secrets.OCI_USER }}" 2>&1 || true)
          if echo "$user_info" | grep -q "ServiceError"; then
            echo "âš ï¸  ç”¨æˆ·è®¤è¯å¯èƒ½å­˜åœ¨é—®é¢˜"
          else
            echo "âœ… ç”¨æˆ·è®¤è¯æˆåŠŸ"
          fi

      # ==========================================================================
      # æ­¥éª¤4ï¼šæ£€æŸ¥ç°æœ‰å®ä¾‹çŠ¶æ€ï¼ˆå¯è·³è¿‡ï¼‰
      # é€»è¾‘ï¼šå¦‚æœå­˜åœ¨éTERMINATEDçš„å®ä¾‹ï¼Œç»ˆæ­¢å·¥ä½œæµ
      # ==========================================================================
      - name: Check existing instances
        if: ${{ !github.event.inputs.skip_instance_check }}
        id: check-instances
        run: |
          echo "=== æ£€æŸ¥ç°æœ‰å®ä¾‹çŠ¶æ€ ==="
          
          # åˆ›å»ºé”™è¯¯æ—¥å¿—æ–‡ä»¶
          mkdir -p ./logs
          rm -f ./logs/instance_list_err.json
          
          # åˆ—å‡ºæ‰€æœ‰å®ä¾‹
          set +e
          instances_json=$(oci compute instance list \
            --compartment-id "${{ secrets.OCI_TENANCY }}" \
            --all \
            --output json 2>./logs/instance_list_err.json)
          rc=$?
          set -e
          
          if [ $rc -ne 0 ]; then
            echo "âŒ æ— æ³•åˆ—å‡ºå®ä¾‹"
            if [ -s ./logs/instance_list_err.json ]; then
              echo "é”™è¯¯è¯¦æƒ…ï¼š"
              cat ./logs/instance_list_err.json
            fi
            exit 1
          fi
          
          # æ£€æŸ¥è¿”å›çš„JSONæ˜¯å¦ä¸ºç©º
          instances_json=${instances_json:-'[]'}
          
          # è¿‡æ»¤æ‰TERMINATEDçŠ¶æ€çš„å®ä¾‹
          non_terminated=$(echo "$instances_json" | jq '[.[]? | select(.state != "TERMINATED")]' 2>/dev/null || echo '[]')
          non_terminated_count=$(echo "$non_terminated" | jq 'length')
          total_count=$(echo "$instances_json" | jq 'length')
          
          echo "å‘ç°å®ä¾‹ï¼šæ€»è®¡ $total_count ä¸ªï¼Œæ´»è·ƒï¼ˆéç»ˆæ­¢ï¼‰$non_terminated_count ä¸ª"
          
          if [ "$non_terminated_count" -gt 0 ]; then
            echo ""
            echo "âŒ å­˜åœ¨æ´»è·ƒå®ä¾‹ï¼Œå°†ç»ˆæ­¢å·¥ä½œæµ"
            echo "æ´»è·ƒå®ä¾‹åˆ—è¡¨ï¼š"
            echo "$non_terminated" | jq -r '.[] | "  - \(.display_name // .id): \(.shape) - \(.state)"'
            echo ""
            echo "åº”è¯¥å‘é€é‚®ä»¶é€šçŸ¥ï¼šinstance_already_exists"
            echo "should_send=true" >> $GITHUB_OUTPUT
            echo "response_message=instance_already_exists" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "âœ… æ²¡æœ‰æ´»è·ƒå®ä¾‹ï¼Œå¯ä»¥ç»§ç»­åˆ›å»º"
            echo "should_send=false" >> $GITHUB_OUTPUT
            echo "response_message=" >> $GITHUB_OUTPUT
          fi

      # ==========================================================================
      # æ­¥éª¤5ï¼šåˆ›å»ºæ–°çš„Ubuntu ARMå®ä¾‹ï¼ˆå¸¦é‡è¯•é€»è¾‘ï¼‰
      # ==========================================================================
      - name: Create Ubuntu ARM instance with retry
        id: create-instance
        env:
          MAX_RETRIES: ${{ github.event.inputs.max_retries || '3' }}
          RETRY_DELAY: 120
        run: |
          echo "=== åˆ›å»ºUbuntu ARMå®ä¾‹ï¼ˆå¸¦é‡è¯•é€»è¾‘ï¼‰ ==="
          echo "é…ç½®ï¼š"
          echo "- å®ä¾‹ç±»å‹ï¼šVM.Standard.A1.Flex"
          echo "- CPUé…ç½®ï¼š4 OCPU"
          echo "- å†…å­˜é…ç½®ï¼š24 GB"
          echo "- æ¶æ„ï¼šARM (Ampere A1)"
          echo "- ç³»ç»Ÿï¼šUbuntu 22.04"
          echo "- é‡è¯•é…ç½®ï¼šæœ€å¤š $MAX_RETRIES æ¬¡"
          echo "- é‡è¯•é—´éš”ï¼š${RETRY_DELAY} ç§’"
          
          # éªŒè¯å¿…è¦çš„ secret
          if [ -z "${{ secrets.SSH_PUBLIC_KEY }}" ]; then
            echo "âŒ SSH_PUBLIC_KEY æœªé…ç½®"
            echo "response_message=ssh_key_missing" >> $GITHUB_OUTPUT
            echo "error_category=configuration" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # è·å–å¯ç”¨æ€§åŸŸ
          echo "è·å–å¯ç”¨æ€§åŸŸ..."
          ad=$(oci iam availability-domain list \
            --compartment-id "${{ secrets.OCI_TENANCY }}" \
            --query 'data[0]."name"' \
            --raw-output 2>./logs/ad_err.txt || echo "")
          
          if [ -z "$ad" ]; then
            echo "âŒ æ— æ³•è·å–å¯ç”¨æ€§åŸŸ"
            cat ./logs/ad_err.txt 2>/dev/null || true
            echo "response_message=availability_domain_error" >> $GITHUB_OUTPUT
            echo "error_category=infrastructure" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "å¯ç”¨æ€§åŸŸï¼š$ad"
          
          # è·å–é•œåƒID
          echo "è·å–Ubuntu 22.04 ARMé•œåƒ..."
          image_id=$(oci compute image list \
            --compartment-id "${{ secrets.OCI_TENANCY }}" \
            --operating-system "Canonical Ubuntu" \
            --operating-system-version "22.04" \
            --all \
            --query "data[0].id" \
            --raw-output 2>./logs/image_err.txt || echo "")
          
          if [ -z "$image_id" ] || [ "$image_id" == "null" ]; then
            echo "âŒ æ— æ³•æ‰¾åˆ°Ubuntu 22.04é•œåƒ"
            cat ./logs/image_err.txt 2>/dev/null || true
            echo "response_message=image_not_found" >> $GITHUB_OUTPUT
            echo "error_category=resource" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "é•œåƒIDï¼š$image_id"
          
          # è·å–ç½‘ç»œé…ç½®ï¼ˆä½¿ç”¨åç§°è€Œä¸æ˜¯OCIDï¼‰
          echo "è·å–ç½‘ç»œé…ç½®..."
          
          # æ£€æŸ¥æ˜¯å¦æŒ‡å®šäº†VCNå’ŒSubnetåç§°
          VCN_NAME="${{ secrets.VCN_NAME }}"
          SUBNET_NAME="${{ secrets.SUBNET_NAME }}"
          
          # å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œä½¿ç”¨é»˜è®¤å€¼æˆ–ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„
          if [ -z "$VCN_NAME" ]; then
            echo "æœªæŒ‡å®šVCNåç§°ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„VCN"
            vcn_id=$(oci network vcn list \
              --compartment-id "${{ secrets.OCI_TENANCY }}" \
              --query 'data[0]."id"' \
              --raw-output 2>./logs/vcn_err.txt || echo "")
          else
            echo "ä½¿ç”¨æŒ‡å®šçš„VCNåç§°ï¼š$VCN_NAME"
            vcn_id=$(oci network vcn list \
              --compartment-id "${{ secrets.OCI_TENANCY }}" \
              --query "data[?\"display-name\"=='$VCN_NAME'].id | [0]" \
              --raw-output 2>./logs/vcn_err.txt || echo "")
          fi
          
          if [ -z "$vcn_id" ] || [ "$vcn_id" == "null" ]; then
            echo "âŒ æ— æ³•æ‰¾åˆ°VCN"
            cat ./logs/vcn_err.txt 2>/dev/null || true
            echo "ğŸ’¡ æç¤ºï¼šè¯·åœ¨Secretsä¸­è®¾ç½® VCN_NAME æˆ–ç¡®ä¿è‡³å°‘å­˜åœ¨ä¸€ä¸ªVCN"
            echo "response_message=vcn_not_found" >> $GITHUB_OUTPUT
            echo "error_category=network" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # è·å–VCNçš„æ˜¾ç¤ºåç§°ï¼ˆç”¨äºæ—¥å¿—ï¼‰
          vcn_display_name=$(oci network vcn get \
            --vcn-id "$vcn_id" \
            --query 'data."display-name"' \
            --raw-output 2>/dev/null || echo "VCN-ID: $vcn_id")
          
          echo "æ‰¾åˆ°VCNï¼š$vcn_display_name"
          
          # æŸ¥æ‰¾Subnet
          if [ -z "$SUBNET_NAME" ]; then
            echo "æœªæŒ‡å®šSubnetåç§°ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„Subnet"
            subnet_id=$(oci network subnet list \
              --compartment-id "${{ secrets.OCI_TENANCY }}" \
              --vcn-id "$vcn_id" \
              --query 'data[0]."id"' \
              --raw-output 2>./logs/subnet_err.txt || echo "")
          else
            echo "ä½¿ç”¨æŒ‡å®šçš„Subnetåç§°ï¼š$SUBNET_NAME"
            subnet_id=$(oci network subnet list \
              --compartment-id "${{ secrets.OCI_TENANCY }}" \
              --vcn-id "$vcn_id" \
              --query "data[?\"display-name\"=='$SUBNET_NAME'].id | [0]" \
              --raw-output 2>./logs/subnet_err.txt || echo "")
          fi
          
          if [ -z "$subnet_id" ] || [ "$subnet_id" == "null" ]; then
            echo "âŒ æ— æ³•æ‰¾åˆ°Subnet"
            cat ./logs/subnet_err.txt 2>/dev/null || true
            echo "ğŸ’¡ æç¤ºï¼šè¯·åœ¨Secretsä¸­è®¾ç½® SUBNET_NAME æˆ–ç¡®ä¿VCNä¸­å­˜åœ¨è‡³å°‘ä¸€ä¸ªSubnet"
            echo "response_message=subnet_not_found" >> $GITHUB_OUTPUT
            echo "error_category=network" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # è·å–Subnetçš„æ˜¾ç¤ºåç§°ï¼ˆç”¨äºæ—¥å¿—ï¼‰
          subnet_display_name=$(oci network subnet get \
            --subnet-id "$subnet_id" \
            --query 'data."display-name"' \
            --raw-output 2>/dev/null || echo "Subnet-ID: $subnet_id")
          
          echo "æ‰¾åˆ°Subnetï¼š$subnet_display_name"
          echo "âœ… ç½‘ç»œé…ç½®å·²å°±ç»ª"
          
          # ç”Ÿæˆå”¯ä¸€å®ä¾‹åç§°
          instance_name="ubuntu-arm-4c24g-$(date +%Y%m%d-%H%M%S)"
          echo "å®ä¾‹åç§°ï¼š$instance_name"
          
          # åˆ›å»ºé”™è¯¯æ—¥å¿—ç›®å½•
          mkdir -p ./logs
          
          # é‡è¯•å¾ªç¯
          success=false
          last_error=""
          
          for attempt in $(seq 1 $MAX_RETRIES); do
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "å°è¯• $attempt / $MAX_RETRIES"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # æ¸…ç©ºä¹‹å‰çš„é”™è¯¯æ—¥å¿—
            rm -f ./logs/oci_err.json ./logs/response.json
            
            # å°è¯•åˆ›å»ºå®ä¾‹
            set +e
            instance_response=$(oci compute instance launch \
              --availability-domain "$ad" \
              --compartment-id "${{ secrets.OCI_TENANCY }}" \
              --shape "VM.Standard.A1.Flex" \
              --shape-config '{"ocpus": 4, "memoryInGBs": 24}' \
              --display-name "$instance_name" \
              --image-id "$image_id" \
              --subnet-id "$subnet_id" \
              --ssh-authorized-keys-file <(echo "${{ secrets.SSH_PUBLIC_KEY }}") \
              --assign-public-ip true \
              --query 'data' \
              --raw-output 2>./logs/oci_err.json)
            create_rc=$?
            set -e
            
            if [ $create_rc -eq 0 ] && [ -n "$instance_response" ]; then
              # æˆåŠŸåˆ›å»º
              echo "âœ… å®ä¾‹åˆ›å»ºæˆåŠŸï¼"
              
              instance_id=$(echo "$instance_response" | jq -r '.id' || echo "")
              lifecycle_state=$(echo "$instance_response" | jq -r '."lifecycle-state"' || echo "")
              private_ip=$(echo "$instance_response" | jq -r '.primary_vnic["private-ip"]' || echo "")
              
              echo "å®ä¾‹ä¿¡æ¯ï¼š"
              echo "- å®ä¾‹IDï¼š$instance_id"
              echo "- çŠ¶æ€ï¼š$lifecycle_state"
              echo "- ç§æœ‰IPï¼š$private_ip"
              
              # ç­‰å¾…å®ä¾‹å¯åŠ¨
              echo "ç­‰å¾…å®ä¾‹å¯åŠ¨ï¼ˆæœ€å¤š5åˆ†é’Ÿï¼‰..."
              sleep 300
              
              # è·å–å…¬ç½‘IP
              public_ip=""
              if [ -n "$instance_id" ]; then
                public_ip=$(oci compute instance list-vnics \
                  --instance-id "$instance_id" \
                  --query 'data[0]."public-ip"' \
                  --raw-output 2>/dev/null || echo "")
              fi
              
              echo ""
              echo "ğŸ“‹ è¿æ¥ä¿¡æ¯ï¼š"
              echo "- å®ä¾‹IDï¼š$instance_id"
              echo "- å…¬ç½‘IPï¼š$public_ip"
              echo "- SSHå‘½ä»¤ï¼šssh ubuntu@$public_ip"
              echo ""
              echo "âœ… å®Œæˆ"
              
              success=true
              echo "response_message=success" >> $GITHUB_OUTPUT
              echo "instance_id=$instance_id" >> $GITHUB_OUTPUT
              echo "public_ip=$public_ip" >> $GITHUB_OUTPUT
              break
              
            else
              # åˆ›å»ºå¤±è´¥ï¼Œåˆ†æé”™è¯¯ç±»å‹
              echo "âŒ åˆ›å»ºå¤±è´¥"
              echo "é€€å‡ºä»£ç ï¼š$create_rc"
              
              # è°ƒè¯•è¾“å‡º
              echo "æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ï¼š"
              ls -la ./logs/ 2>/dev/null || echo "logsç›®å½•ä¸å­˜åœ¨"
              
              if [ -s ./logs/oci_err.json ]; then
                echo "è¯»å–é”™è¯¯æ—¥å¿—æ–‡ä»¶ï¼š"
                cat ./logs/oci_err.json || echo "æ— æ³•è¯»å–æ—¥å¿—æ–‡ä»¶"
                
                # æå–é”™è¯¯ä¿¡æ¯
                err_json=$(cat ./logs/oci_err.json 2>/dev/null)
                error_code=$(echo "$err_json" | jq -r '.code // "Unknown"' 2>/dev/null || echo "Unknown")
                error_message=$(echo "$err_json" | jq -r '.message // "Unknown error"' 2>/dev/null || echo "Unknown error")
                
                echo "é”™è¯¯ä»£ç ï¼š$error_code"
                echo "é”™è¯¯ä¿¡æ¯ï¼š$error_message"
              else
                echo "âš ï¸ é”™è¯¯æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©º"
                echo "ç›´æ¥è¾“å‡ºOCI CLIçš„é”™è¯¯ï¼š"
                # å°è¯•ç›´æ¥ä»å‘½ä»¤è¾“å‡ºè·å–é”™è¯¯
                error_message="OCI CLIå‘½ä»¤å¤±è´¥ï¼ˆé€€å‡ºä»£ç ï¼š$create_rcï¼‰"
                error_code="CommandFailed"
                echo "é”™è¯¯ä»£ç ï¼š$error_code"
                echo "é”™è¯¯ä¿¡æ¯ï¼š$error_message"
              fi
              
              # åˆ†ç±»é”™è¯¯ï¼ˆåœ¨ifå—å¤–ï¼Œé¿å…é‡å¤ï¼‰
              error_category="unknown"
              should_retry="false"
              
              case "$error_message" in
                "Out of host capacity"*)
                  error_category="capacity"
                  should_retry="true"
                  echo "ğŸ’¡ æç¤ºï¼šè¿™æ˜¯å®¹é‡ä¸è¶³é”™è¯¯ï¼Œå¯ä»¥é‡è¯•"
                  ;;
                "NotAuthorizedOrNotFound")
                  error_category="permission"
                  should_retry="false"
                  echo "ğŸ’¡ æç¤ºï¼šæƒé™ä¸è¶³ï¼Œè¯·æ£€æŸ¥IAMç­–ç•¥"
                  ;;
                "InvalidParameter"*)
                  error_category="configuration"
                  should_retry="false"
                  echo "ğŸ’¡ æç¤ºï¼šé…ç½®å‚æ•°é”™è¯¯"
                  ;;
                "LimitExceeded"*)
                  error_category="quota"
                  should_retry="false"
                  echo "ğŸ’¡ æç¤ºï¼šè¶…å‡ºæœåŠ¡é™åˆ¶"
                  ;;
                "InternalError"*)
                  error_category="service"
                  should_retry="true"
                  echo "ğŸ’¡ æç¤ºï¼šOCIæœåŠ¡å†…éƒ¨é”™è¯¯ï¼Œå¯ä»¥é‡è¯•"
                  ;;
                *)
                  error_category="unknown"
                  should_retry="true"
                  echo "ğŸ’¡ æç¤ºï¼šæœªçŸ¥é”™è¯¯ï¼Œå°è¯•é‡è¯•"
                  ;;
              esac
              
              # ä¿å­˜é”™è¯¯ä¿¡æ¯
              last_error="$error_message"
              echo "error_category=$error_category" >> $GITHUB_OUTPUT
              echo "error_message=$error_message" >> $GITHUB_OUTPUT
              
              # å†³å®šæ˜¯å¦é‡è¯•
              if [ "$should_retry" = "true" ] && [ $attempt -lt $MAX_RETRIES ]; then
                echo "â³ ç­‰å¾… ${RETRY_DELAY} ç§’åé‡è¯•..."
                sleep $RETRY_DELAY
              elif [ "$should_retry" = "false" ]; then
                echo "âŒ ä¸å¯é‡è¯•çš„é”™è¯¯ï¼Œç»ˆæ­¢"
                break
              fi
            fi
          done
          
          # å¦‚æœæ‰€æœ‰é‡è¯•éƒ½å¤±è´¥äº†
          if [ "$success" = "false" ]; then
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ æ‰€æœ‰å°è¯•å‡å¤±è´¥"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "æœ€åé”™è¯¯ï¼š$last_error"
            echo ""
            echo "ğŸ’¡ å»ºè®®ï¼š"
            echo "1. æ£€æŸ¥OCIæ§åˆ¶å°ä¸­çš„æœåŠ¡é…é¢"
            echo "2. å°è¯•ä¸åŒçš„åŒºåŸŸï¼ˆus-phoenix-1 æˆ– us-ashburn-1ï¼‰"
            echo "3. å‡å°‘èµ„æºéœ€æ±‚ï¼ˆå¦‚æ”¹ä¸º 2 OCPU + 12 GBï¼‰"
            echo "4. ç­‰å¾…æ•°å°æ—¶åé‡è¯•"
            echo "5. æ£€æŸ¥IAMæƒé™ç­–ç•¥"
            echo ""
            
            # è®¾ç½®é”™è¯¯å“åº”
            echo "response_message=$last_error" >> $GITHUB_OUTPUT
            echo "error_category=${error_category:-unknown}" >> $GITHUB_OUTPUT
            exit 1
          fi

      # ==========================================================================
      # æ­¥éª¤6ï¼šå†³å®šæ˜¯å¦å‘é€é‚®ä»¶é€šçŸ¥
      # ==========================================================================
      - name: Decide email notification
        id: decide
        run: |
          echo "=== å†³å®šæ˜¯å¦å‘é€é‚®ä»¶é€šçŸ¥ ==="
          
          # è¯»å–ä»“åº“çš„ message.jsonï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f message.json ]; then
            repo_messages=$(jq -c '.message // []' message.json || echo '[]')
            echo "ä»“åº“æ¶ˆæ¯é…ç½®ï¼š$repo_messages"
          else
            repo_messages='[]'
            echo "æœªæ‰¾åˆ° message.jsonï¼Œå°†ä¸æ¯”è¾ƒ"
          fi
          
          # è·å–å“åº”æ¶ˆæ¯
          response_message="${{ steps.create-instance.outputs.response_message }}"
          
          # å¦‚æœå®ä¾‹æ£€æŸ¥å¤±è´¥ï¼Œä½¿ç”¨å…¶è¾“å‡º
          if [ -z "$response_message" ] && [ -n "${{ steps.check-instances.outputs.response_message }}" ]; then
            response_message="${{ steps.check-instances.outputs.response_message }}"
          fi
          
          echo "å“åº”æ¶ˆæ¯ï¼š$response_message"
          
          if [ -z "$response_message" ] || [ "$response_message" = "success" ]; then
            echo "âœ… æˆåŠŸï¼Œä¸éœ€è¦å‘é€é‚®ä»¶"
            echo "should_send=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æ£€æŸ¥æ˜¯å¦åœ¨å·²çŸ¥æ¶ˆæ¯åˆ—è¡¨ä¸­
          if [ "$repo_messages" != "[]" ]; then
            contains=$(echo "$repo_messages" | jq --arg rm "$response_message" 'index($rm) != null' 2>/dev/null || echo "false")
            
            if [ "$contains" = "true" ]; then
              echo "æ¶ˆæ¯åœ¨é…ç½®åˆ—è¡¨ä¸­ï¼Œä¸å‘é€"
              echo "should_send=false" >> $GITHUB_OUTPUT
            else
              echo "æ–°é”™è¯¯æ¶ˆæ¯ï¼Œéœ€è¦å‘é€é‚®ä»¶"
              echo "should_send=true" >> $GITHUB_OUTPUT
            fi
          else
            # å¦‚æœæ²¡æœ‰é…ç½®æ–‡ä»¶ï¼Œé»˜è®¤å‘é€
            echo "æœªé…ç½®æ¶ˆæ¯åˆ—è¡¨ï¼Œå‘é€é‚®ä»¶"
            echo "should_send=true" >> $GITHUB_OUTPUT
          fi
          
          echo "response_message=$response_message" >> $GITHUB_OUTPUT

      # ==========================================================================
      # æ­¥éª¤7ï¼šå‘é€é‚®ä»¶é€šçŸ¥
      # ==========================================================================
      - name: Check SMTP configuration
        id: smtp-check
        run: |
          if [ -z "${{ secrets.SMTP_SERVER }}" ] || [ -z "${{ secrets.EMAIL_TO }}" ]; then
            echo "smtp_configured=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  SMTPæœªå®Œå…¨é…ç½®"
          else
            echo "smtp_configured=true" >> $GITHUB_OUTPUT
            echo "âœ… SMTPå·²é…ç½®"
          fi

      - name: Send email notification
        if: steps.decide.outputs.should_send == 'true' && steps.smtp-check.outputs.smtp_configured == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT || '587' }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: '[OCI Auto-Manager] å®ä¾‹ç®¡ç†å·¥ä½œæµçŠ¶æ€'
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.SMTP_USERNAME }}
          body: |
            OCI ARMå®ä¾‹ç®¡ç†å·¥ä½œæµæ‰§è¡ŒçŠ¶æ€æŠ¥å‘Š
            
            å·¥ä½œæµä¿¡æ¯ï¼š
            - è¿è¡ŒIDï¼š${{ github.run_id }}
            - è¿è¡Œç¼–å·ï¼š${{ github.run_number }}
            - è§¦å‘åŸå› ï¼š${{ github.event_name }}
            ${{ github.event_name == 'workflow_dispatch' && format('- æ‰‹åŠ¨è§¦å‘åŸå› ï¼š{0}', github.event.inputs.manual_trigger_reason) || '' }}
            
            æ‰§è¡Œç»“æœï¼š
            - çŠ¶æ€ï¼š{{ steps.decide.outputs.response_message }}
            ${{ steps.create-instance.outputs.instance_id && format('- å®ä¾‹IDï¼š{0}', steps.create-instance.outputs.instance_id) || '' }}
            ${{ steps.create-instance.outputs.public_ip && format('- å…¬ç½‘IPï¼š{0}', steps.create-instance.outputs.public_ip) || '' }}
            ${{ steps.create-instance.outputs.error_category && format('- é”™è¯¯ç±»åˆ«ï¼š{0}', steps.create-instance.outputs.error_category) || '' }}
            
            å½“å‰æ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')
            
            æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼š${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Log skipped email
        if: steps.decide.outputs.should_send == 'true' && steps.smtp-check.outputs.smtp_configured == 'false'
        run: |
          echo "âš ï¸  åº”è¯¥å‘é€é‚®ä»¶ä½†SMTPæœªé…ç½®"

