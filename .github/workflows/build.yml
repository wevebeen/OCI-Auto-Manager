name: OCI Ubuntu ARM Instance Auto-Manager

# è§¦å‘æ¡ä»¶
on:
  # å®šæ—¶è§¦å‘ï¼šæ¯å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆæ•´ç‚¹æ‰§è¡Œï¼‰
  schedule:
    - cron: '0 * * * *'
  # æ‰‹åŠ¨è§¦å‘ï¼šå…è®¸é€šè¿‡GitHubç•Œé¢æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
    inputs:
      manual_trigger_reason:
        description: 'æ‰‹åŠ¨è§¦å‘åŸå› '
        required: false
        default: 'æµ‹è¯•æˆ–ç´§æ€¥æ“ä½œ'

jobs:
  manage-oci-instances:
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 30

    steps:
      # ==========================================================================
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç ä»“åº“
      # ==========================================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ==========================================================================
      # æ­¥éª¤2ï¼šé…ç½®OCIè®¤è¯ä¿¡æ¯
      # æ‰€éœ€Secretsï¼š
      # - OCI_USER: Oracle Cloudç”¨æˆ·OCID
      # - OCI_TENANCY: Oracle Cloudç§Ÿæˆ·OCID
      # - OCI_FINGERPRINT: APIå¯†é’¥æŒ‡çº¹
      # - OCI_REGION: åŒºåŸŸæ ‡è¯†ç¬¦ï¼ˆå¦‚ï¼šus-ashburn-1ï¼‰
      # - OCI_PRIVATE_KEY: APIç§é’¥å†…å®¹ï¼ˆPEMæ ¼å¼ï¼‰
      # ==========================================================================
      - name: Configure OCI authentication
        run: |
          echo "=== é…ç½®OCIè®¤è¯ä¿¡æ¯ ==="
          
          # åˆ›å»ºOCIé…ç½®ç›®å½•
          mkdir -p ~/.oci
          
          # ç”ŸæˆOCIé…ç½®æ–‡ä»¶
          cat > ~/.oci/config << 'CONFIG_EOF'
          [DEFAULT]
          user=${{ secrets.OCI_USER }}
          tenancy=${{ secrets.OCI_TENANCY }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          region=${{ secrets.OCI_REGION }}
          key_file=~/.oci/oci_api_key.pem
          CONFIG_EOF
          
          # ä¿å­˜APIç§é’¥ï¼ˆæ›´å¥å£®çš„å†™æ³•ï¼‰
          if [ -z "${{ secrets.OCI_PRIVATE_KEY }}" ]; then
            echo "âŒ OCI_PRIVATE_KEY secret is empty or not available in this workflow run."
            echo "   - å‚æ•°ä¸å­˜åœ¨"
            echo "   - å¦‚æœè¿™æ˜¯æ¥è‡ª fork çš„ PR æˆ–éå—ä¿¡ä»»è§¦å‘ï¼ŒGitHub å¯èƒ½ä¸ä¼šæ³¨å…¥ Secretsã€‚"
            exit 1
          fi

          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/oci_api_key.pem

          # è®¾ç½®æ–‡ä»¶æƒé™ï¼ˆå®‰å…¨è¦æ±‚ï¼‰
          chmod 600 ~/.oci/config
          chmod 600 ~/.oci/oci_api_key.pem

          # è¾“å‡ºæ–‡ä»¶å¤§å°ä¸æœ«è¡Œä»¥ä¾¿éªŒè¯ï¼ˆä¸ä¼šæ‰“å°ç§é’¥ä¸»ä½“ï¼‰
          echo "oci_api_key.pem size: $(wc -c < ~/.oci/oci_api_key.pem) bytes"
          echo "oci_api_key.pem last line: '$(tail -n 1 ~/.oci/oci_api_key.pem)'"
          
          echo "âœ… OCIè®¤è¯é…ç½®å®Œæˆ"

      # ==========================================================================
      # æ­¥éª¤3ï¼šå®‰è£…OCI CLIå·¥å…·
      # ==========================================================================
      - name: Install OCI CLI
        run: |
          echo "=== å®‰è£…OCI CLIå·¥å…· ==="
          
          # ä¸‹è½½å¹¶å®‰è£…OCI CLI
          curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh | bash -s -- --accept-all-defaults
          
          # é…ç½®ç¯å¢ƒå˜é‡
          echo 'export PATH=$HOME/bin:$PATH' >> ~/.bashrc
          source ~/.bashrc
          # å°† $HOME/bin å†™å…¥ GITHUB_PATHï¼Œç¡®ä¿åç»­æ­¥éª¤å¯ä»¥ç›´æ¥ä½¿ç”¨ oci
          echo "$HOME/bin" >> $GITHUB_PATH
          # ç«‹å³æŠŠ $HOME/bin åŠ å…¥å½“å‰ PATHï¼Œä½¿å¾—æœ¬æ­¥éª¤å¯ä»¥ç«‹åˆ»ä½¿ç”¨ oci
          export PATH="$HOME/bin:$PATH"
          
          # éªŒè¯å®‰è£…
          oci --version
          echo "âœ… OCI CLIå®‰è£…å®Œæˆ"

      # ======================================================================
      # æ­¥éª¤3.1ï¼šé¢„æ£€ OCI é…ç½®ï¼ˆéªŒè¯èº«ä»½å’Œ Compartmentï¼‰
      # ======================================================================
      - name: Pre-check OCI configuration
        run: |
          echo "=== é¢„æ£€ OCI é…ç½® ==="
          set -e
          echo "æ£€æŸ¥ä»£ç å·²æ³¨é‡Šï¼Œä¸ç”Ÿæ•ˆï¼Œé¿å…æš´éœ²ä¿¡æ¯"
          # # æ‰“å°å½“å‰ configï¼ˆä¸è¦æŠŠç§é’¥ä¸Šä¼ åˆ°æ—¥å¿—ï¼‰
          # echo "=== ~/.oci/config (first 40 lines) ==="
          # sed -n '1,40p' ~/.oci/config || true

          # # éªŒè¯ç”¨æˆ·ï¼ˆåº”è¿”å› user dataï¼‰
          # echo "=== oci iam user get ==="
          # oci iam user get --user-id "${{ secrets.OCI_USER }}" --raw-output || echo "user get failed (see above)"

          # # æ£€æŸ¥ compartment æ˜¯å¦å­˜åœ¨å¹¶è¿”å›è¯¦æƒ…ï¼ˆè¿™æ˜¯ç›®å‰å¤±è´¥çš„è°ƒç”¨ï¼‰
          # echo "=== oci iam compartment get ==="
          # oci iam compartment get --compartment-id "${{secrets.OCI_TENANCY}}" --raw-output || echo "compartment get failed (å¯èƒ½æ˜¯ OCID é”™/æ— æƒé™)"

          # # åœ¨ tenancy ä¸‹åˆ—å‡ºæ‰€æœ‰ compartmentsï¼ˆç”¨æ¥åœ¨åˆ—è¡¨ä¸­ç¡®è®¤ä½ ä½¿ç”¨çš„ OCIDï¼‰
          # echo "=== list compartments under tenancy ==="
          # oci iam compartment list --compartment-id "${{secrets.OCI_TENANCY}}" --all --output table || echo "compartment list failed (æƒé™?)"

          # # åˆ—å‡ºå½“å‰ç”¨æˆ·æ‰€å±çš„ç»„ï¼ˆç”¨äºç¡®è®¤ç”¨æˆ·å±äºå“ªä¸ªç»„ï¼‰
          # echo "=== groups for user ==="
          # oci iam user list-groups --user-id "${{ secrets.OCI_USER }}" --raw-output || echo "list-groups failed (æƒé™?)"

          # # åˆ—å‡º tenancy ä¸‹çš„ policyï¼ˆå¸®åŠ©æŸ¥çœ‹æ˜¯å¦å­˜åœ¨æˆäºˆæ‰€å±ç»„è®¿é—®è¯¥ compartment çš„ç­–ç•¥ï¼‰
          # echo "=== policy list in tenancy ==="
          # oci iam policy list --compartment-id "${{secrets.OCI_TENANCY}}" --all --output table || echo "policy list failed (æƒé™?)"

          # # ä½œä¸ºæœ€ç»ˆæµ‹è¯•ï¼Œå°è¯•å¯¹ç›®æ ‡ compartment åˆ—å‡º compute å®ä¾‹ï¼ˆè¿™ä¸€æ­¥å¦‚æœæƒé™ç¼ºä¼šæŠ¥ NotAuthorizedOrNotFoundï¼‰
          # echo "=== compute instance list (test) ==="
          # oci compute instance list --compartment-id "${{secrets.OCI_TENANCY}}" --all --output table || echo "compute list failed"

          # echo "âœ… é¢„æ£€é€šè¿‡ï¼šOCI é…ç½®çœ‹èµ·æ¥æ­£å¸¸"

      # ==========================================================================
      # æ­¥éª¤4ï¼šæ£€æŸ¥å®ä¾‹çŠ¶æ€
      # é€»è¾‘ï¼šå¦‚æœå­˜åœ¨ä»»ä½•çŠ¶æ€çš„å®ä¾‹ï¼Œç»ˆæ­¢å·¥ä½œæµ
      # ==========================================================================
      - name: Check instance existence
        run: |
          echo "=== æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä»»ä½•å®ä¾‹ï¼ˆTERMINATED å¯å¿½ç•¥ï¼‰ ==="

          # å®¹é”™æ‰§è¡Œ list è°ƒç”¨ä»¥ä¾¿åœ¨å¤±è´¥æ—¶è¾“å‡º debug å¸®åŠ©æ’æŸ¥
          set +e
          instances_json=$(oci compute instance list \
            --compartment-id "${{secrets.OCI_TENANCY}}" \
            --query 'data[*].{id:id, name:"display-name", shape:shape, state:"lifecycle-state"}' \
            --raw-output 2>/dev/null)
          rc=$?
          set -e

          if [ $rc -ne 0 ]; then
            echo "OCI CLI list failed; printing debug output to help troubleshooting"
            oci --debug compute instance list \
              --compartment-id "${{secrets.OCI_TENANCY}}" \
              --query 'data[*].{id:id, name:"display-name", shape:shape, state:"lifecycle-state"}' \
              --raw-output || true
            echo "æ£€æŸ¥å»ºè®®ï¼šç¡®è®¤ä»“åº“ Secrets ä¸­çš„ OCI_TENANCY/OCI_USER/OCI_FINGERPRINT/OCI_REGION/OCI_PRIVATE_KEY æ˜¯å¦ä¸ºæ­£ç¡®å€¼ï¼Œä¸”æ‰€ç”¨ç”¨æˆ·æœ‰ list instances çš„æƒé™ã€‚"
            exit 1
          fi

          # å¤„ç†å¯èƒ½çš„ null è¿”å›ï¼Œç¡®ä¿ä¸ºæ•°ç»„
          instances_json=${instances_json:-[]}

          # è¿‡æ»¤æ‰ lifecycle-state ä¸º TERMINATED çš„å®ä¾‹ï¼Œç»Ÿè®¡å‰©ä½™ï¼ˆé TERMINATEDï¼‰æ•°é‡
          non_terminated_json=$(echo "$instances_json" | jq '[.[] | select(.state != "TERMINATED")]')
          non_terminated_count=$(echo "$non_terminated_json" | jq 'length')
          total_count=$(echo "$instances_json" | jq 'length')

          echo "æ€»å…±å‘ç° $total_count ä¸ªå®ä¾‹ï¼›å…¶ä¸­é TERMINATED çš„æ•°é‡ï¼š$non_terminated_count"

          if [ "$non_terminated_count" -gt 0 ]; then
            echo "å­˜åœ¨é TERMINATED çš„å®ä¾‹ï¼Œåˆ—å‡ºå¹¶ç»ˆæ­¢å·¥ä½œæµï¼š"
            echo "$non_terminated_json" | jq -r '.[] | "- åç§°ï¼š\(.name) | ç±»å‹ï¼š\(.shape) | çŠ¶æ€ï¼š\(.state) | IDï¼š\(.id)"'
            echo "âŒ å‘ç°æ­£åœ¨è¿è¡Œ/éç»ˆæ­¢çŠ¶æ€çš„å®ä¾‹ï¼Œç»ˆæ­¢å·¥ä½œæµ"
            exit 1
          else
            if [ "$total_count" -gt 0 ]; then
              echo "å‘ç°çš„å®ä¾‹å‡ä¸º TERMINATEDï¼ˆå¯ç»§ç»­åˆ›å»ºæ–°å®ä¾‹ï¼‰ï¼š"
              echo "$instances_json" | jq -r '.[] | "- åç§°ï¼š\(.name) | ç±»å‹ï¼š\(.shape) | çŠ¶æ€ï¼š\(.state) | IDï¼š\(.id)"'
            else
              echo "æœªå‘ç°ä»»ä½•å®ä¾‹ï¼Œç»§ç»­æ‰§è¡Œ"
            fi
            echo "âœ… ç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤"
          fi

      # ==========================================================================
      # æ­¥éª¤5ï¼šåˆ›å»ºæ–°çš„Ubuntu ARMå®ä¾‹ï¼ˆ4C24Gï¼‰
      # æ‰€éœ€Secretsï¼š
      # - SSH_PUBLIC_KEY: ç”¨äºSSHç™»å½•çš„å…¬é’¥
      # ==========================================================================
      - name: Create new Ubuntu ARM instance (4C24G)
        run: |
          echo "=== åˆ›å»ºæ–°çš„Ubuntu ARMå®ä¾‹ ==="
          echo "é…ç½®ä¿¡æ¯ï¼š"
          echo "- å®ä¾‹ç±»å‹ï¼šVM.Standard.A1.Flex"
          echo "- CPUé…ç½®ï¼š4 OCPU"
          echo "- å†…å­˜é…ç½®ï¼š24 GB"
          echo "- æ¶æ„ç±»å‹ï¼šARM (Ampere A1)"
          echo "- æ“ä½œç³»ç»Ÿï¼šCanonical Ubuntu 22.04 Minimal aarch64"
          echo "- ç½‘ç»œé…ç½®ï¼šåˆ†é…å…¬ç½‘IP"
          echo "- ç¬¦åˆOracle Cloudå§‹ç»ˆå…è´¹æ¡ä»¶"
          
          # è·å–å¯ç”¨æ€§åŸŸï¼ˆä½¿ç”¨ tenancy OCIDï¼‰
          echo "æ­£åœ¨è·å–å¯ç”¨æ€§åŸŸ..."
          ad=$(oci iam availability-domain list \
            --compartment-id ${{secrets.OCI_TENANCY}} \
            --query 'data[0]."name"' \
            --raw-output)
          echo "ä½¿ç”¨å¯ç”¨æ€§åŸŸï¼š$ad"
          
          # è·å–Ubuntu 22.04 ARMé•œåƒåˆ—è¡¨ï¼ˆå…ˆä¿å­˜å®Œæ•´ JSON ä»¥ä¾¿è°ƒè¯•ï¼‰
          echo "æ­£åœ¨åˆ—å‡ºé•œåƒï¼ˆOCI CLI è°ƒç”¨ï¼‰..."
          image_id=$(oci compute image list \
              --compartment-id "${{secrets.OCI_TENANCY}}" \
              --operating-system "Canonical Ubuntu" \
              --operating-system-version "22.04" \
              --all \
              --query "data[0].id" \
              --raw-output)
          
          echo "ä½¿ç”¨é•œåƒIDï¼š$image_id"
          
          # è·å–ç½‘ç»œé…ç½®
          echo "æ­£åœ¨è·å–ç½‘ç»œé…ç½®..."
          vcn_id=$(oci network vcn list \
            --compartment-id ${{secrets.OCI_TENANCY}} \
            --query 'data[0]."id"' \
            --raw-output)
          subnet_id=$(oci network subnet list \
            --compartment-id ${{secrets.OCI_TENANCY}} \
            --vcn-id $vcn_id \
            --query 'data[0]."id"' \
            --raw-output)
          echo "ç½‘ç»œé…ç½®IDï¼š$subnet_id"
          
          # ç”Ÿæˆå”¯ä¸€å®ä¾‹åç§°
          instance_name="ubuntu-arm-4c24g-$(date +%Y%m%d-%H%M%S)"
          echo "å®ä¾‹åç§°ï¼š$instance_name"
          
          # å¯åŠ¨å®ä¾‹
          echo "æ­£åœ¨å¯åŠ¨å®ä¾‹ï¼Œè¯·ç¨å€™..."
          if [ -z "${{secrets.SSH_PUBLIC_KEY}}" ]; then
            echo "âŒ SSH_PUBLIC_KEY is empty. Please provide SSH public key as workflow input."
            exit 1
          fi

          instance_response=$(oci compute instance launch \
            --availability-domain "$ad" \
            --compartment-id "${{secrets.OCI_TENANCY}}" \
            --shape "VM.Standard.A1.Flex" \
            --shape-config '{"ocpus": 4, "memoryInGBs": 24}' \
            --display-name "$instance_name" \
            --image-id "$image_id" \
            --subnet-id "$subnet_id" \
            --ssh-authorized-keys-file <(echo "${{secrets.SSH_PUBLIC_KEY}}") \
            --assign-public-ip true \
            --query 'data' \
            --raw-output)
          
          echo "è§£æå®ä¾‹ä¿¡æ¯"
          # è§£æå®ä¾‹ä¿¡æ¯
          instance_id=$(echo "$instance_response" | jq -r '.id')
          lifecycle_state=$(echo "$instance_response" | jq -r '["lifecycle-state"]')
          private_ip=$(echo "$instance_response" | jq -r '.primary_vnic["private-ip"]')
          
          echo "âœ… å®ä¾‹åˆ›å»ºæˆåŠŸï¼"
          echo "- å®ä¾‹IDï¼š$instance_id"
          echo "- å½“å‰çŠ¶æ€ï¼š$lifecycle_state"
          echo "- ç§æœ‰IPï¼š$private_ip"
          
          # ç­‰å¾…å®ä¾‹å®Œå…¨å¯åŠ¨
          echo "ç­‰å¾…å®ä¾‹å®Œå…¨å¯åŠ¨ï¼ˆæœ€å¤šç­‰å¾…5åˆ†é’Ÿï¼‰..."
          sleep 300
          
          # è·å–å…¬ç½‘IP
          echo "æ­£åœ¨è·å–å…¬ç½‘IP..."
          public_ip=$(oci compute instance list-vnics \
            --instance-id "$instance_id" \
            --query 'data[0]."public-ip"' \
            --raw-output)
          
          # è¾“å‡ºè¿æ¥ä¿¡æ¯
          echo "ğŸ“‹ å®ä¾‹è¿æ¥ä¿¡æ¯ï¼š"
          echo "- å®ä¾‹åç§°ï¼š$instance_name"
          echo "- å®ä¾‹IDï¼š$instance_id"
          echo "- å®ä¾‹çŠ¶æ€ï¼š$(oci compute instance get --instance-id $instance_id --query 'data["lifecycle-state"]' --raw-output)"
          echo "- ç§æœ‰IPï¼š$private_ip"
          echo "- å…¬ç½‘IPï¼š$public_ip"
          echo "- SSHç”¨æˆ·åï¼šubuntu"
          echo "- SSHè¿æ¥å‘½ä»¤ï¼šssh ubuntu@$public_ip"
          echo "- æ³¨æ„ï¼šé¦–æ¬¡è¿æ¥å¯èƒ½éœ€è¦ç­‰å¾…å‡ åˆ†é’Ÿ"

      # # ==========================================================================
      # # æ­¥éª¤6ï¼šä¸Šä¼ å®ä¾‹ä¿¡æ¯
      # # ==========================================================================
      # - name: Upload instance information
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: ubuntu-arm-instance-details
      #     path: instance_details.json
      #     retention-days: 7
